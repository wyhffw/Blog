name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Build application
      run: |
        echo "开始构建 Go 应用..."
        mkdir -p bin
        if ! go build -o bin/wyhblog ./cmd/server; then
          echo "❌ 构建失败"
          exit 1
        fi
        chmod +x bin/wyhblog
        echo "✅ 构建完成，文件大小: $(du -h bin/wyhblog | cut -f1)"

    # 关键修复：添加 SSH 密钥验证和准备步骤
    - name: Setup and Validate SSH Environment
      run: |
        echo "=== 验证部署环境 ==="
        
        # 检查必要的 Secrets 是否存在
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "❌ 错误: SERVER_HOST Secret 未设置"
          exit 1
        fi
        
        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "❌ 错误: SERVER_USER Secret 未设置"
          exit 1
        fi
        
        if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
          echo "❌ 错误: SERVER_SSH_KEY Secret 未设置"
          exit 1
        fi
        
        echo "✅ 所有必要的 Secrets 都已设置"
        echo "服务器地址: ${{ secrets.SERVER_HOST }}"
        echo "用户名: ${{ secrets.SERVER_USER }}"
        
        # 创建 SSH 密钥文件
        echo "=== 设置 SSH 密钥 ==="
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # 将私钥写入文件
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/wyhblog_deploy_key
        
        # 检查文件是否成功写入
        if [ ! -s ~/.ssh/wyhblog_deploy_key ]; then
          echo "❌ SSH 密钥文件为空"
          exit 1
        fi
        
        # 设置正确的权限
        chmod 600 ~/.ssh/wyhblog_deploy_key
        
        # 验证密钥格式
        echo "=== 验证 SSH 密钥格式 ==="
        if head -1 ~/.ssh/wyhblog_deploy_key | grep -q "PRIVATE KEY"; then
          echo "✅ SSH 私钥格式正确"
        else
          echo "❌ SSH 私钥格式错误"
          echo "第一行: $(head -1 ~/.ssh/wyhblog_deploy_key)"
          exit 1
        fi
        
        # 尝试解析密钥
        if ssh-keygen -l -f ~/.ssh/wyhblog_deploy_key >/dev/null 2>&1; then
          echo "✅ SSH 密钥可正常解析"
        else
          echo "❌ SSH 密钥无法解析"
          echo "错误信息:"
          ssh-keygen -l -f ~/.ssh/wyhblog_deploy_key 2>&1 || true
          exit 1
        fi
        
        # 测试服务器连通性（不验证主机密钥）
        echo "=== 测试服务器连通性 ==="
        echo "正在测试连接到 ${{ secrets.SERVER_HOST }}:22..."
        
        # 添加服务器到 known_hosts（跳过验证）
        ssh-keyscan -p 22 ${{ secrets.SERVER_HOST }} 2>/dev/null >> ~/.ssh/known_hosts || true
        
        echo "✅ 环境验证完成"

    - name: Deploy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key_path: ~/.ssh/wyhblog_deploy_key  # 使用文件路径而不是 key 参数
        port: 22
        source: "bin/wyhblog,web/dist,deploy/"
        target: "/opt/wyhblog"
        strip_components: 0
        overwrite: true
        debug: true  # 启用调试输出

    - name: Execute deployment script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key_path: ~/.ssh/wyhblog_deploy_key  # 使用文件路径
        port: 22
        script: |
          set -e  # 遇到错误立即退出
          
          echo "=== 开始部署流程 ==="
          echo "部署时间: $(date)"
          echo "服务器: $(hostname)"
          echo "当前用户: $(whoami)"
          
          # 确保在正确的目录
          cd /opt/wyhblog
          echo "当前目录: $(pwd)"
          echo "目录内容:"
          ls -la
          
          # 检查必要的文件是否存在
          if [ ! -f "wyhblog" ]; then
            echo "❌ 错误: wyhblog 可执行文件不存在"
            exit 1
          fi
          
          # 设置可执行权限
          chmod +x wyhblog
          
          # 创建必要的目录
          echo "=== 创建系统目录 ==="
          sudo mkdir -p /var/lib/wyhblog /etc/wyhblog /var/log/wyhblog
          
          # 设置目录权限
          echo "=== 设置目录权限 ==="
          if id www-data &>/dev/null; then
            echo "使用 www-data 用户"
            sudo chown -R www-data:www-data /var/lib/wyhblog /var/log/wyhblog
          elif id nginx &>/dev/null; then
            echo "使用 nginx 用户"
            sudo chown -R nginx:nginx /var/lib/wyhblog /var/log/wyhblog
          else
            echo "⚠️ 未找到 www-data 或 nginx 用户，使用当前用户"
            sudo chown -R $(whoami):$(whoami) /var/lib/wyhblog /var/log/wyhblog
          fi
          
          # 安装 systemd 服务
          echo "=== 配置系统服务 ==="
          if [ -f "deploy/wyhblog.service" ]; then
            echo "找到服务文件，正在安装..."
            sudo cp deploy/wyhblog.service /etc/systemd/system/
            sudo systemctl daemon-reload
            echo "✅ 服务文件已安装"
          else
            echo "⚠️ 未找到 deploy/wyhblog.service 文件"
          fi
          
          # 重启服务
          echo "=== 重启服务 ==="
          if sudo systemctl is-active wyhblog &>/dev/null; then
            echo "服务正在运行，尝试重启..."
            sudo systemctl restart wyhblog
            echo "✅ 服务重启完成"
          else
            echo "服务未运行，尝试启动..."
            sudo systemctl start wyhblog || echo "⚠️ 启动服务失败（可能是首次部署）"
          fi
          
          # 等待服务状态稳定
          sleep 2
          
          # 检查服务状态
          echo "=== 服务状态检查 ==="
          if sudo systemctl is-active wyhblog &>/dev/null; then
            echo "✅ wyhblog 服务正在运行"
            sudo systemctl status wyhblog --no-pager
          else
            echo "⚠️ wyhblog 服务未运行"
            echo "检查服务状态:"
            sudo systemctl status wyhblog --no-pager || true
          fi
          
          # 检查进程
          echo "=== 进程检查 ==="
          if pgrep -x "wyhblog" >/dev/null; then
            echo "✅ wyhblog 进程正在运行"
            ps aux | grep wyhblog | grep -v grep
          else
            echo "⚠️ 未找到 wyhblog 进程"
          fi
          
          echo "=== 部署完成 ==="
          echo "完成时间: $(date)"
