name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Build application
      run: |
        echo "å¼€å§‹æ„å»º Go åº”ç”¨..."
        mkdir -p bin
        go build -o bin/wyhblog ./cmd/server
        chmod +x bin/wyhblog
        echo "âœ… æ„å»ºå®Œæˆ"

    # ä¿®å¤ï¼šåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶åˆ›å»ºå’ŒéªŒè¯æ­¥éª¤
    - name: Create and Validate SSH Key File
      id: setup_ssh
      run: |
        echo "=== åˆ›å»º SSH å¯†é’¥æ–‡ä»¶ ==="
        
        # è®¾ç½®å˜é‡
        SSH_DIR="/home/runner/.ssh"
        KEY_PATH="$SSH_DIR/wyhblog_deploy_key"
        
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "Home ç›®å½•: $HOME"
        echo "SSH ç›®å½•: $SSH_DIR"
        echo "å¯†é’¥è·¯å¾„: $KEY_PATH"
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p "$SSH_DIR"
        chmod 700 "$SSH_DIR"
        
        # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶
        rm -f "$KEY_PATH"
        
        # å†™å…¥ç§é’¥
        echo "æ­£åœ¨å†™å…¥ç§é’¥..."
        echo "${{ secrets.SERVER_SSH_KEY }}" > "$KEY_PATH"
        
        # æ£€æŸ¥æ–‡ä»¶
        echo "=== æ£€æŸ¥æ–‡ä»¶ ==="
        if [ ! -f "$KEY_PATH" ]; then
          echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶æœªåˆ›å»º"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo "$SSH_DIR ç›®å½•å†…å®¹:"
          ls -la "$SSH_DIR" || echo "ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… æ–‡ä»¶åˆ›å»ºæˆåŠŸ"
        echo "æ–‡ä»¶å¤§å°: $(wc -c < "$KEY_PATH") å­—èŠ‚"
        echo "æ–‡ä»¶æƒé™:"
        ls -la "$KEY_PATH"
        
        # è®¾ç½®æƒé™
        chmod 600 "$KEY_PATH"
        echo "è®¾ç½®æƒé™å: $(stat -c "%a" "$KEY_PATH")"
        
        # éªŒè¯å¯†é’¥æ ¼å¼
        echo "=== éªŒè¯å¯†é’¥æ ¼å¼ ==="
        if ssh-keygen -l -f "$KEY_PATH" >/dev/null 2>&1; then
          echo "âœ… å¯†é’¥æ ¼å¼æ­£ç¡®"
          echo "å…¬é’¥æŒ‡çº¹:"
          ssh-keygen -l -f "$KEY_PATH"
        else
          echo "âŒ å¯†é’¥æ ¼å¼é”™è¯¯"
          echo "é”™è¯¯ä¿¡æ¯:"
          ssh-keygen -l -f "$KEY_PATH" 2>&1
          exit 1
        fi
        
        # è¾“å‡ºæ–‡ä»¶è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "KEY_PATH=$KEY_PATH" >> $GITHUB_ENV

    - name: Display Public Key
      run: |
        echo "=== å…¬é’¥ä¿¡æ¯ ==="
        KEY_PATH="${{ env.KEY_PATH }}"
        
        echo "å…¬é’¥å†…å®¹:"
        ssh-keygen -y -f "$KEY_PATH" 2>/dev/null
        
        echo ""
        echo "è¯·ç¡®ä¿æ­¤å…¬é’¥å·²åœ¨æœåŠ¡å™¨çš„ ~/.ssh/authorized_keys ä¸­"

    - name: Test SSH Connection with Debug
      run: |
        echo "=== è¯¦ç»† SSH è¿æ¥æµ‹è¯• ==="
        KEY_PATH="${{ env.KEY_PATH }}"
        
        echo "å¯†é’¥æ–‡ä»¶: $KEY_PATH"
        echo "æ–‡ä»¶å­˜åœ¨: $(if [ -f "$KEY_PATH" ]; then echo "æ˜¯"; else echo "å¦"; fi)"
        echo "æ–‡ä»¶æƒé™: $(stat -c "%a" "$KEY_PATH" 2>/dev/null || echo "æ— æ³•è·å–")"
        
        if [ ! -f "$KEY_PATH" ]; then
          echo "âŒ é”™è¯¯ï¼šå¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨ï¼"
          echo "æ£€æŸ¥ /home/runner/.ssh ç›®å½•:"
          ls -la /home/runner/.ssh/ || echo "ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ˜¾ç¤ºå¯†é’¥å†…å®¹ï¼ˆå‰å‡ è¡Œï¼‰
        echo "å¯†é’¥å†…å®¹å‰3è¡Œ:"
        head -3 "$KEY_PATH"
        
        # æµ‹è¯•è¿æ¥
        echo ""
        echo "æ­£åœ¨æµ‹è¯•è¿æ¥åˆ° ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}..."
        
        # å…ˆæ·»åŠ åˆ° known_hosts
        ssh-keyscan -p 22 "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null
        
        # æµ‹è¯•è¿æ¥ï¼ˆå¸¦è¶…æ—¶ï¼‰
        timeout 10 ssh -v \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=5 \
          -i "$KEY_PATH" \
          -p 22 \
          "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" \
          "echo 'âœ… è¿æ¥æˆåŠŸ'; exit 0" && {
          echo "âœ… SSH è¿æ¥æµ‹è¯•é€šè¿‡"
        } || {
          echo "âŒ SSH è¿æ¥å¤±è´¥"
          echo "å¯èƒ½çš„åŸå› :"
          echo "1. æœåŠ¡å™¨ä¸Šæ²¡æœ‰å¯¹åº”çš„å…¬é’¥"
          echo "2. SSH æœåŠ¡é…ç½®é—®é¢˜"
          echo "3. é˜²ç«å¢™æˆ–å®‰å…¨ç»„é™åˆ¶"
          exit 1
        }

    # å¦‚æœ SSH æµ‹è¯•æˆåŠŸï¼Œç»§ç»­éƒ¨ç½²
    - name: Deploy files to server
      if: success()
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key_path: ${{ env.KEY_PATH }}
        port: 22
        source: "bin/wyhblog,web/dist,deploy/"
        target: "/opt/wyhblog"
        strip_components: 0
        overwrite: true
        debug: true

    - name: Execute deployment script
      if: success()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key_path: ${{ env.KEY_PATH }}
        port: 22
        script: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "æœåŠ¡å™¨: $(hostname)"
          echo "æ—¶é—´: $(date)"
          echo ""
          echo "å·²éƒ¨ç½²æ–‡ä»¶:"
          ls -la /opt/wyhblog/
