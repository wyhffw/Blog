name: Deploy to Server - Fixed Version

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Build application
      run: |
        echo "å¼€å§‹æ„å»º Go åº”ç”¨..."
        mkdir -p bin
        go build -o bin/wyhblog ./cmd/server
        chmod +x bin/wyhblog
        echo "âœ… æ„å»ºå®Œæˆ"

    # ä½¿ç”¨ä¸åŒæ–¹æ³•ï¼šåœ¨è¿è¡Œæ—¶åˆ›å»ºå¯†é’¥æ–‡ä»¶
    - name: Prepare SSH for SCP Action
      run: |
        echo "=== ä¸º SCP Action å‡†å¤‡ SSH ==="
        
        # åˆ›å»º .ssh ç›®å½•
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # ç›´æ¥å†™å…¥å¯†é’¥æ–‡ä»¶
        KEY_FILE="/home/runner/.ssh/deploy_key"
        echo "${{ secrets.SERVER_SSH_KEY }}" > "$KEY_FILE"
        
        # éªŒè¯æ–‡ä»¶
        echo "æ£€æŸ¥å¯†é’¥æ–‡ä»¶..."
        if [ -f "$KEY_FILE" ]; then
          echo "âœ… å¯†é’¥æ–‡ä»¶åˆ›å»ºæˆåŠŸ: $KEY_FILE"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < "$KEY_FILE") å­—èŠ‚"
          
          # è®¾ç½®æƒé™
          chmod 600 "$KEY_FILE"
          echo "æƒé™è®¾ç½®å®Œæˆ"
          
          # éªŒè¯å¯†é’¥
          echo "éªŒè¯å¯†é’¥æ ¼å¼..."
          if ssh-keygen -l -f "$KEY_FILE" >/dev/null 2>&1; then
            echo "âœ… å¯†é’¥æ ¼å¼æœ‰æ•ˆ"
          else
            echo "âŒ å¯†é’¥æ ¼å¼æ— æ•ˆ"
            ssh-keygen -l -f "$KEY_FILE" 2>&1
          fi
        else
          echo "âŒ å¯†é’¥æ–‡ä»¶åˆ›å»ºå¤±è´¥"
          exit 1
        fi
        
        # æ·»åŠ åˆ° known_hosts
        ssh-keyscan -p 22 "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "âœ… SSH å‡†å¤‡å®Œæˆ"

    - name: Deploy files using direct SCP command
      run: |
        echo "=== ä½¿ç”¨ SCP å‘½ä»¤ç›´æ¥éƒ¨ç½² ==="
        
        KEY_FILE="/home/runner/.ssh/deploy_key"
        SERVER="${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        
        echo "æœåŠ¡å™¨: $SERVER"
        echo "å¯†é’¥æ–‡ä»¶: $KEY_FILE"
        
        # æµ‹è¯•è¿æ¥
        echo "æµ‹è¯• SSH è¿æ¥..."
        ssh -o StrictHostKeyChecking=no \
            -i "$KEY_FILE" \
            -p 22 \
            "$SERVER" \
            "echo 'SSH è¿æ¥æµ‹è¯•æˆåŠŸ'; exit 0" || {
          echo "âŒ SSH è¿æ¥å¤±è´¥"
          echo "è¯·ç¡®ä¿:"
          echo "1. æœåŠ¡å™¨ä¸Šå·²æ·»åŠ å…¬é’¥åˆ° ~/.ssh/authorized_keys"
          echo "2. SSH æœåŠ¡æ­£åœ¨è¿è¡Œ"
          echo "3. é˜²ç«å¢™å…è®¸ç«¯å£ 22"
          exit 1
        }
        
        # åˆ›å»ºè¿œç¨‹ç›®å½•
        echo "åˆ›å»ºè¿œç¨‹ç›®å½•..."
        ssh -o StrictHostKeyChecking=no \
            -i "$KEY_FILE" \
            -p 22 \
            "$SERVER" \
            "mkdir -p /opt/wyhblog"
        
        # ä½¿ç”¨ scp ä¸Šä¼ æ–‡ä»¶
        echo "ä¸Šä¼ æ–‡ä»¶..."
        
        # ä¸Šä¼  wyhblog å¯æ‰§è¡Œæ–‡ä»¶
        scp -o StrictHostKeyChecking=no \
            -i "$KEY_FILE" \
            -P 22 \
            bin/wyhblog \
            "$SERVER:/opt/wyhblog/"
        
        # ä¸Šä¼  web/dist ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "web/dist" ]; then
          scp -o StrictHostKeyChecking=no \
              -i "$KEY_FILE" \
              -P 22 \
              -r web/dist \
              "$SERVER:/opt/wyhblog/"
        fi
        
        # ä¸Šä¼  deploy ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "deploy" ]; then
          scp -o StrictHostKeyChecking=no \
              -i "$KEY_FILE" \
              -P 22 \
              -r deploy \
              "$SERVER:/opt/wyhblog/"
        fi
        
        echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"

    - name: Execute remote deployment script
      run: |
        echo "=== æ‰§è¡Œè¿œç¨‹éƒ¨ç½²è„šæœ¬ ==="
        
        KEY_FILE="/home/runner/.ssh/deploy_key"
        SERVER="${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        ssh -o StrictHostKeyChecking=no \
            -i "$KEY_FILE" \
            -p 22 \
            "$SERVER" << 'EOF'
          echo "å¼€å§‹è¿œç¨‹éƒ¨ç½²..."
          echo "æ—¶é—´: $(date)"
          echo "æœåŠ¡å™¨: $(hostname)"
          
          cd /opt/wyhblog || { echo "æ— æ³•è¿›å…¥ /opt/wyhblog"; exit 1; }
          
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          
          # è®¾ç½®å¯æ‰§è¡Œæƒé™
          if [ -f "wyhblog" ]; then
            chmod +x wyhblog
            echo "âœ… è®¾ç½® wyhblog å¯æ‰§è¡Œæƒé™"
          fi
          
          # åˆ›å»ºç³»ç»Ÿç›®å½•
          sudo mkdir -p /var/lib/wyhblog /etc/wyhblog /var/log/wyhblog 2>/dev/null || true
          
          # è®¾ç½®ç›®å½•æƒé™
          if id www-data &>/dev/null; then
            sudo chown -R www-data:www-data /var/lib/wyhblog /var/log/wyhblog 2>/dev/null || true
            echo "ä½¿ç”¨ www-data ç”¨æˆ·"
          elif id nginx &>/dev/null; then
            sudo chown -R nginx:nginx /var/lib/wyhblog /var/log/wyhblog 2>/dev/null || true
            echo "ä½¿ç”¨ nginx ç”¨æˆ·"
          else
            echo "ä½¿ç”¨å½“å‰ç”¨æˆ·"
          fi
          
          # å®‰è£… systemd æœåŠ¡
          if [ -f "deploy/wyhblog.service" ]; then
            echo "å®‰è£… systemd æœåŠ¡..."
            sudo cp deploy/wyhblog.service /etc/systemd/system/ 2>/dev/null || true
            sudo systemctl daemon-reload 2>/dev/null || true
            sudo systemctl restart wyhblog 2>/dev/null || true
            echo "âœ… æœåŠ¡é…ç½®å®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° deploy/wyhblog.service"
          fi
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
EOF
