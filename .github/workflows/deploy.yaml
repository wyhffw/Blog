name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Build application
      run: |
        echo "开始构建 Go 应用..."
        mkdir -p bin
        go build -o bin/wyhblog ./cmd/server
        chmod +x bin/wyhblog
        echo "✅ 构建完成"

    - name: Setup SSH Environment
      run: |
        echo "=== 设置 SSH 环境 ==="
        
        # 创建 SSH 目录和密钥文件
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # 使用完整的绝对路径
        KEY_PATH="/home/runner/.ssh/wyhblog_deploy_key"
        echo "${{ secrets.SERVER_SSH_KEY }}" > "$KEY_PATH"
        chmod 600 "$KEY_PATH"
        
        # 验证密钥
        echo "✅ 密钥文件创建成功"
        echo "文件路径: $KEY_PATH"
        echo "文件信息:"
        ls -la "$KEY_PATH"
        echo ""
        echo "密钥指纹:"
        ssh-keygen -l -f "$KEY_PATH"

    - name: Display Public Key for Server
      run: |
        echo "=== 公钥信息 ==="
        KEY_PATH="/home/runner/.ssh/wyhblog_deploy_key"
        
        echo "公钥内容（已添加到服务器）:"
        ssh-keygen -y -f "$KEY_PATH" 2>/dev/null
        
        echo ""
        echo "公钥指纹:"
        ssh-keygen -l -f "$KEY_PATH"

    - name: Test SSH Connection
      run: |
        echo "=== 测试 SSH 连接 ==="
        KEY_PATH="/home/runner/.ssh/wyhblog_deploy_key"
        
        # 添加到 known_hosts
        ssh-keyscan -p 22 "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null
        
        # 测试连接
        echo "测试连接到服务器..."
        ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            -i "$KEY_PATH" \
            -p 22 \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" \
            "echo '✅ SSH 连接成功'; hostname" || {
          echo "❌ SSH 连接失败"
          echo "请确保服务器上的 authorized_keys 包含正确的公钥"
          exit 1
        }

    - name: Deploy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key_path: /home/runner/.ssh/wyhblog_deploy_key  # 使用绝对路径
        port: 22
        source: "bin/wyhblog,web/dist,deploy/"
        target: "/opt/wyhblog"
        strip_components: 0
        overwrite: true
        debug: true

    - name: Execute deployment script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key_path: /home/runner/.ssh/wyhblog_deploy_key  # 使用绝对路径
        port: 22
        script: |
          echo "✅ 部署成功！"
          echo "服务器: $(hostname)"
          echo "时间: $(date)"
          echo ""
          echo "部署的文件:"
          ls -la /opt/wyhblog/
          echo ""
          echo "检查 wyhblog 可执行文件:"
          if [ -f "/opt/wyhblog/wyhblog" ]; then
            chmod +x /opt/wyhblog/wyhblog
            echo "文件权限: $(ls -la /opt/wyhblog/wyhblog)"
          fi
