name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆå¿…é¡»ç¬¬ä¸€æ­¥ï¼‰
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰æ–‡ä»¶

    # 2. è®¾ç½® Go ç¯å¢ƒ
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    # 3. æ„å»ºåº”ç”¨
    - name: Build application
      run: |
        echo "å¼€å§‹æ„å»º Go åº”ç”¨..."
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        
        # åˆ›å»º bin ç›®å½•
        mkdir -p bin
        
        # å°è¯•ä¸åŒçš„æ„å»ºæ–¹å¼
        if [ -d "cmd/server" ]; then
          echo "æ„å»º cmd/server..."
          go build -o bin/wyhblog ./cmd/server
        elif [ -f "main.go" ]; then
          echo "æ„å»º main.go..."
          go build -o bin/wyhblog .
        else
          # æŸ¥æ‰¾ main.go
          MAIN_FILE=$(find . -name "main.go" -type f | head -1)
          if [ ! -z "$MAIN_FILE" ]; then
            echo "æ‰¾åˆ° main.go: $MAIN_FILE"
            go build -o bin/wyhblog "$MAIN_FILE"
          else
            echo "âŒ æœªæ‰¾åˆ°å…¥å£æ–‡ä»¶"
            exit 1
          fi
        fi
        
        chmod +x bin/wyhblog
        echo "âœ… æ„å»ºå®Œæˆ: $(du -h bin/wyhblog | cut -f1)"

    # 4. è°ƒè¯•ï¼šåˆ—å‡ºè¦éƒ¨ç½²çš„æ–‡ä»¶
    - name: List files to deploy
      run: |
        echo "=== è¦éƒ¨ç½²çš„æ–‡ä»¶ ==="
        echo ""
        echo "1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
        [ -f "go.mod" ] && echo "âœ… go.mod" || echo "âŒ go.mod (ç¼ºå¤±)"
        [ -f "go.sum" ] && echo "âœ… go.sum" || echo "âŒ go.sum (ç¼ºå¤±)"
        [ -d "web/" ] && echo "âœ… web/ ç›®å½•" || echo "âŒ web/ (ç¼ºå¤±)"
        [ -d "deploy/" ] && echo "âœ… deploy/ ç›®å½•" || echo "âŒ deploy/ (ç¼ºå¤±)"
        [ -f "bin/wyhblog" ] && echo "âœ… bin/wyhblog" || echo "âŒ bin/wyhblog (ç¼ºå¤±)"
        
        echo ""
        echo "2. ç›®å½•ç»“æ„:"
        ls -la
        
        echo ""
        echo "3. å…·ä½“æ–‡ä»¶:"
        find . -type f -name "*.go" -o -name "go.*" -o -name "*.yaml" -o -name "*.yml" -o -name "*.json" | head -20

    # 5. ä½¿ç”¨ scp-action éƒ¨ç½²ï¼ˆæœ€å¯é ï¼‰
    - name: Deploy to server using SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        source: |
          bin/wyhblog
          web/
          deploy/
          go.mod
          go.sum
          *.yaml
          *.yml
          *.json
          .env*
          README*
          Dockerfile*
        target: "/opt/wyhblog"
        strip_components: 0
        overwrite: true
        debug: true

    # 6. åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… Go å¹¶é‡æ–°ç¼–è¯‘ï¼ˆè§£å†³ GLIBC é—®é¢˜ï¼‰
    - name: Install Go and compile on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "=== åœ¨æœåŠ¡å™¨ä¸Šç¼–è¯‘åº”ç”¨ ==="
          
          # è¿›å…¥ç›®å½•
          cd /opt/wyhblog
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          
          # å®‰è£… Goï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
          if ! command -v go &> /dev/null; then
            echo "å®‰è£… Go..."
            cd /tmp
            wget -q https://go.dev/dl/go1.22.0.linux-amd64.tar.gz
            sudo tar -C /usr/local -xzf go1.22.0.linux-amd64.tar.gz
            echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
            export PATH=$PATH:/usr/local/go/bin
          fi
          
          echo "Go ç‰ˆæœ¬: $(go version)"
          
          # é‡æ–°ç¼–è¯‘åº”ç”¨
          echo "é‡æ–°ç¼–è¯‘åº”ç”¨..."
          if [ -f "go.mod" ]; then
            go mod download
          fi
          
          # ç¼–è¯‘
          if [ -d "cmd/server" ]; then
            go build -o bin/wyhblog_centos ./cmd/server
          else
            go build -o bin/wyhblog_centos .
          fi
          
          # æ›¿æ¢æ—§æ–‡ä»¶
          if [ -f "bin/wyhblog_centos" ]; then
            mv -f bin/wyhblog_centos bin/wyhblog
            chmod +x bin/wyhblog
            echo "âœ… é‡æ–°ç¼–è¯‘æˆåŠŸ"
            file bin/wyhblog
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

    # 7. é…ç½®å’Œå¯åŠ¨æœåŠ¡
    - name: Configure and start service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "=== é…ç½®æœåŠ¡å™¨ ==="
          
          # è¿›å…¥ç›®å½•
          cd /opt/wyhblog
          
          # ç¡®ä¿å¯æ‰§è¡Œæƒé™
          chmod +x bin/wyhblog
          
          # åœæ­¢æ—§è¿›ç¨‹
          pkill -9 wyhblog 2>/dev/null || true
          
          # å¯åŠ¨åº”ç”¨
          echo "å¯åŠ¨åº”ç”¨..."
          nohup ./bin/wyhblog > /tmp/wyhblog.log 2>&1 &
          sleep 3
          
          # æ£€æŸ¥æ˜¯å¦è¿è¡Œ
          if netstat -tln | grep :8080 > /dev/null; then
            echo "âœ… åº”ç”¨å·²å¯åŠ¨ï¼Œç›‘å¬ 8080 ç«¯å£"
          else
            echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
            tail -20 /tmp/wyhblog.log
            exit 1
          fi
          
          # é…ç½® Nginx
          echo "é…ç½® Nginx..."
          if ! command -v nginx &> /dev/null; then
            sudo yum install epel-release nginx -y
          fi
          
          sudo tee /etc/nginx/conf.d/wyhblog.conf << 'EOF'
server {
    listen 80;
    server_name wyhblog.xyz www.wyhblog.xyz;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
EOF
          
          sudo systemctl restart nginx
          sudo systemctl enable nginx
          
          # æœ€ç»ˆæµ‹è¯•
          echo "æµ‹è¯•è®¿é—®..."
          curl -s -o /dev/null -w "æœ¬åœ°åº”ç”¨: %{http_code}\n" http://localhost:8080
          curl -s -o /dev/null -w "Nginxä»£ç†: %{http_code}\n" http://localhost
          
          echo ""
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
          echo "è®¿é—®: http://wyhblog.xyz"

    # 8. éªŒè¯éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰
    - name: Verify deployment
      run: |
        echo "éƒ¨ç½²éªŒè¯:"
        echo "1. æ£€æŸ¥æ„å»ºäº§ç‰©:"
        ls -la bin/wyhblog 2>/dev/null || echo "æ„å»ºå¤±è´¥"
        echo ""
        echo "2. å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
        echo "è¯·è®¿é—® http://wyhblog.xyz æ£€æŸ¥ç½‘ç«™"
