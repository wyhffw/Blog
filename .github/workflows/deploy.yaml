name: Simple Deploy
on: [push, workflow_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 安装 Go
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    # 3. 构建应用（使用静态编译）
    - name: Build
      run: |
        mkdir -p bin
        echo "设置 Go 代理..."
        go env -w GOPROXY=https://goproxy.cn,direct
        
        echo "下载依赖..."
        go mod download
        
        echo "静态编译应用..."
        # 静态编译，避免 GLIBC 问题
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
          -ldflags="-s -w" \
          -o bin/wyhblog ./cmd/server
        
        chmod +x bin/wyhblog
        echo "✅ 构建完成"
        echo "文件信息:"
        file bin/wyhblog
        echo "大小: $(du -h bin/wyhblog | cut -f1)"
    
          
    # 4. 上传整个项目到服务器
    - name: Upload entire project
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        source: "."
        target: "/opt/wyhblog"
        strip_components: 0
        overwrite: true

    # 5. 在服务器上运行（跳过 Go 编译，直接运行）
    - name: Run on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "=== 服务器部署 ==="
          cd /opt/wyhblog
          
          echo "1. 检查文件:"
          ls -la
          echo ""
          echo "重要文件检查:"
          [ -f "go.mod" ] && echo "✅ go.mod 存在" || echo "❌ go.mod 不存在"
          [ -f "go.sum" ] && echo "✅ go.sum 存在" || echo "❌ go.sum 不存在"
          [ -d "web" ] && echo "✅ web 目录存在" || echo "❌ web 目录不存在"
          [ -d "deploy" ] && echo "✅ deploy 目录存在" || echo "❌ deploy 目录不存在"
          [ -f "bin/wyhblog" ] && echo "✅ bin/wyhblog 存在" || echo "❌ bin/wyhblog 不存在"
          
          echo ""
          echo "2. 启动应用..."
          cd bin
          chmod +x wyhblog
          
          # 停止旧进程
          pkill wyhblog 2>/dev/null || true
          sleep 1
          
          # 启动新进程
          nohup ./wyhblog > ../app.log 2>&1 &
          APP_PID=$!
          sleep 3
          
          echo ""
          echo "3. 检查状态:"
          # 检查进程
          if ps -p $APP_PID > /dev/null; then
            echo "✅ 应用进程运行中 (PID: $APP_PID)"
          else
            echo "❌ 应用进程已退出"
            echo "查看日志:"
            tail -20 ../app.log
            exit 1
          fi
          
          # 检查端口
          if netstat -tln 2>/dev/null | grep :8080 > /dev/null; then
            echo "✅ 应用监听 8080 端口"
          else
            echo "❌ 应用未监听端口"
            echo "查看日志:"
            tail -20 ../app.log
          fi
          
          # 测试访问
          echo ""
          echo "4. 测试访问:"
          curl -s -o /dev/null -w "HTTP状态码: %{http_code}\n" --connect-timeout 5 http://localhost:8080 || echo "访问失败"
          
          echo ""
          echo "🎉 部署完成!"
          echo "访问地址:"
          echo "1. 直接访问应用: http://39.99.34.36:8080"
          echo "2. 域名访问: http://wyhblog.xyz (需要配置 Nginx)"
