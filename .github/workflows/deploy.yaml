name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 设置 Go 环境
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    # 3. 构建应用
    - name: Build application
      run: |
        mkdir -p bin
        go build -o bin/wyhblog ./cmd/server
        chmod +x bin/wyhblog
        echo "✅ 构建完成"

    # 4. 使用 rsync 部署文件 ⬅️ 这是你要添加的步骤
    - name: Deploy files with rsync
      uses: burnett01/rsync-deployments@7.0.1
      with:
        switches: -avz --delete
        path: |
          bin/
          web/
          deploy/
          go.mod
          go.sum
          .env.example
          config.yaml
          docker-compose.yml
          README.md
        remote_path: /opt/wyhblog/
        remote_host: ${{ secrets.SERVER_HOST }}
        remote_user: ${{ secrets.SERVER_USER }}
        remote_key: ${{ secrets.SERVER_SSH_KEY }}

    # 5. 在服务器上执行部署脚本
    - name: Execute deployment script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "开始部署..."
          cd /opt/wyhblog
          
          # 确保可执行权限
          chmod +x bin/wyhblog 2>/dev/null || true
          
          # 重启服务
          sudo systemctl restart wyhblog 2>/dev/null || echo "服务重启失败，可能是首次部署"
          
          echo "✅ 部署完成"
          echo "访问: http://wyhblog.xyz"
