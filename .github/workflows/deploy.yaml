name: Deploy wyhblog
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 设置Go
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # 3. 编译程序
      - name: Build
        run: |
          # 如果你的主文件在根目录叫 main.go
          go build -o wyhblog main.go
          # 或：go build -o wyhblog .
          chmod +x wyhblog

      # 4. 上传到服务器并重启
      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # 进入目录
            cd /opt/wyhblog
            
            # 停止旧程序
            pkill -f wyhblog || true
            sleep 2
            
            # 上传新程序（用scp上传）
            echo "上传文件中..."
            
            # 启动新程序
            nohup ./wyhblog > logs/wyhblog.log 2>&1 &
            
            # 检查是否运行
            sleep 3
            if pgrep -f wyhblog >/dev/null; then
              echo "✅ 部署成功！"
              echo "进程ID: $(pgrep -f wyhblog)"
            else
              echo "❌ 启动失败"
              tail -20 logs/wyhblog.log
              exit 1
            fi
